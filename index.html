<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>AOSPçš„ç§»æ¤å®è·µä¸æŒ‘æˆ˜</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/simple.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/github.css" />

    <link rel="stylesheet" href="./assets/custom.css" />

  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-markdown data-separator="<!--s-->" data-separator-vertical="<!--v-->">
          <textarea data-template>
            

<div class="middle center">
<div style="width: 100%">

# AOSPçš„ç§»æ¤å®è·µä¸æŒ‘æˆ˜
<hr/>

é¾™èŠ¯å®éªŒå®¤ [æœ±å¥‡æ­£](https://github.com/baibaidashixiong)

<div style="text-align: right; margin-top: 1em;">
<p>2025.3.29&emsp;&emsp;&emsp;</p>
</div>
</div>
</div>

<!--s-->

<div class="middle center">
<div style="width: 100%">

# ç›®å½• 
<hr/>
1. AOSPæ€»ä½“æ¦‚è¿°<br>
2. AOSPç§»æ¤éš¾ç‚¹<br>
3. AOSPç§»æ¤å®è·µ<br>

</div>
</div>


<!--s-->

<div class="middle center">
<div style="width: 100%">

# Part.1 
<hr/>
AOSPæ€»ä½“æ¦‚è¿°

</div></div>
<!--v-->
## å®‰å“å†å²
<div style="text-align: center;">
<img src="android_history.svg" width="200%" style="margin: 0 auto;">
</div>
<!--v-->
## æ•´ä½“æ¡†æ¶

<div class="mul-cols">
<div class="col">
<br/>
&nbsp;<img src="android-stack.svg" width="100%" style="margin: 0 auto;">
</div>
<div class="col">

<p style="color: red;">1. Linux Kernel</p>
<p>2. System Services & Daemons</p>
<p style="color: red;">3. HAL</p>
<!--Hardware Abstraction Layer-->
<p style="color: red;">4. Android Runtime</p>
<p>5. System Services</p>
<p>6. Android Framework</p>
<p>7. ... </p>


</div>
</div>

<!--v-->

## Linux Kernel
- ACK(Android Common Kernel)ï¼šåŒ…å«Linux LTSè¡¥ä¸ã€‚
- GKI(Generic Kernel Image)ï¼šå‡å°‘å†…æ ¸ç¢ç‰‡åŒ–ã€‚
<div style="text-align: center;">
<br/>
<img src="generic-kernel-image-architecture.png" width="80%" style="margin: 0 auto;">
</div>

<!--v-->
## HAL
<span style="font-size: 0.8em;">ğŸ“Œ HAL: Hardware Abstraction Layer</span><p>
<span style="font-size: 0.8em;">ğŸ› ï¸ è¿æ¥å®‰å“ç³»ç»Ÿå’Œåº•å±‚ç¡¬ä»¶é©±åŠ¨ç¨‹åº</span><p>
```c[1-3|5-11|13-19]
// frameworks/native/libs/ui/Gralloc4.cpp
using android::hardware::graphics::allocator::V4_0::IAllocator;
using AidlIAllocator = ::aidl::android::hardware::graphics::allocator::IAllocator;

// hardware/interfaces/graphics/allocator/4.0/IAllocator.hal
interface IAllocator {
    allocate(BufferDescriptor descriptor, uint32_t count)
        generates (Error error,
                   uint32_t stride,
                   vec<handle> buffers);
};

// external/minigbm/cros_gralloc/gralloc4/CrosGralloc4Allocator.cc
Error CrosGralloc4Allocator::allocate(const BufferDescriptorInfo& descriptor, uint32_t* outStride,
                                      hidl_handle* outHandle) {
    ...
    int ret = mDriver->allocate(&crosDescriptor, &handle);
    ...
}
```

<!--v-->
## Native Libraries
<div class="mul-cols">
<div class="col">

<span style="font-size: 0.8em;">ğŸ“Œ Bionic: Android's libc</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ ä½“ç§¯æ›´å°</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ é€Ÿåº¦æ›´å¿«</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ åè®®æ›´å®½æ¾</span><p>
&nbsp;<span style="font-size: 0.8em;">â­ ä¸Šå±‚ä¸–ç•Œçš„åŸºçŸ³</span><p>
<span style="font-size: 0.8em;">ğŸ“Œ C/C++ Libraries: ä¾èµ–NDK</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ åº”ç”¨åŠ é€Ÿ</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ ä¿å¯†éœ€æ±‚</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ”€ é€šè¿‡JNIäº¤äº’</span><p>
</div>
<div class="col">
<img src="android-stack1.png" width="80%" style="margin: 0 auto;">
</div>


<!--v-->
## Android Runtime
<div class="mul-cols">
<div class="col">
&nbsp;&nbsp;<img src="art_review.png" width="80%" style="margin: 0 auto;">
</div>
<div class="col">

<span style="font-size: 0.8em;">ğŸ“Œ å®‰å“APK</span><p>
&nbsp;<span style="font-size: 0.6em;">ğŸ“Œ DEXæ–‡ä»¶</span><p>
&nbsp;<span style="font-size: 0.6em;">ğŸ“Œ åŸç”Ÿåº“</span><p>
<span style="font-size: 0.8em;">ğŸ“Œ è¿è¡Œæ—¶æ”¯æŒ</span><p>
&nbsp;<span style="font-size: 0.6em;">ğŸ› ï¸ å„ç§trampoline</span><p>
&nbsp;<span style="font-size: 0.6em;">ğŸ› ï¸ JNIè°ƒç”¨</span><p>
&nbsp;<span style="font-size: 0.6em;">ğŸ› ï¸ è§£é‡Šå™¨</span><p>
&nbsp;<span style="font-size: 0.6em;">ğŸ› ï¸ JIT/AOTç¼–è¯‘å™¨</span><p>
<span style="font-size: 0.6em;">ğŸ“Œ ...</span><p>
</div>
</div>


<!--s-->

<div class="middle center">
<div style="width: 100%">

# Part.2 
<hr/>
AOSPç§»æ¤éš¾ç‚¹

</div>
</div>



<!--v-->
## æ„å»ºç³»ç»Ÿ

<span style="font-size: 0.8em;">ğŸ“Œ AOSPæ„å»ºç³»ç»Ÿæ¼”åŒ–</span><p>
```bash
make(2008)       Kati(2016)        Soong(2017)
Makefile    â¡   Android.mk     â¡  Android.bp

            Android.mk/Android.bp--> .ninja
```
<span style="font-size: 0.8em;">ğŸ’¡ OpenEmbeddedä¸AOSPæ„å»ºç³»ç»Ÿå¯¹æ¯”</span><p>
<div class="three-line">

|OpenEmbedded | AOSP |
|:--:|:--:|
|bb recipe| Android.bp and Android.mk|
|local.conf|AndroidProducts.mk|
|machine.conf| BoardConfig.mk |
|command: bitbake| soong (soong_ui and soong_build)|
|bbclass | build/make/core && build/soong|

</div>

<!--v-->
## æ„å»ºç³»ç»Ÿ

<span style="font-size: 0.8em;">ğŸš€ æ„å»ºå‘½ä»¤: lunch <b>\<product_name\></b>-\<release_config\>-\<build_variant\></span><p>
<div class="mul-cols">
<div class="col">

<span style="font-size: 0.8em;">ğŸ¯ å¯»æ‰¾AndroidProducts.mk</span><p>
```C
PRODUCT_NAME := loongson_3a5000
PRODUCT_CHARACTERISTICS := tablet
...
```
<span style="font-size: 0.8em;">ğŸ¯ BoardConfig.mk</span><p>
```C
BOARD_RAMDISK_USE_LZ4 := true
BOARD_CACHEIMAGE_FILE_SYSTEM_TYPE := ext4
BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE := ext4
BOARD_AVB_ENABLE := false
...
```
</div>
<div class="col">

<span style="font-size: 0.8em;">ğŸ¯ subdevs/graphics/graphics.mk</span><p>

<div style="max-width: 600px; max-height: 200px;">

```C
PRODUCT_SOONG_NAMESPACES += external/mesa

PRODUCT_PACKAGES += \
    hwcomposer.drm \
    hwcomposer.drm_minigbm \
    gralloc.minigbm_dmabuf \
    gralloc.minigbm \
    gralloc.gbm \
    libGLES_mesa \
    libglapi \
    libgallium_dri \
    libOpenglSystemCommon \
    vndservicemanager \
    vndservice

PRODUCT_PACKAGES += \
    android.hardware.graphics.mapper@4.0-impl.minigbm \
    android.hardware.graphics.allocator@2.0-impl \
    android.hardware.graphics.allocator@4.0-service.minigbm \
    android.hardware.graphics.composer@2.1-impl \
    android.hardware.graphics.composer@2.1-service \
```
</div>
</div>
</div>

<!--v-->
## å·¥å…·é“¾

<div class="mul-cols">
<div class="col">

&nbsp;<span style="font-size: 0.8em;">ğŸ¯ Clangå·¥å…·é“¾</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ NDK</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ Rust</span><p>
</div>
<div class="col">

<span style="font-size: 0.8em;">âœ… åç«¯ä»£ç é€‚é…</span><p>
<span style="font-size: 0.8em;">ğŸ› ï¸ BootStrap</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ“Œ Stage1</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ ç¼–è¯‘æœ€å°Clang</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ“Œ Stage2</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ åˆ¶ä½œåŠ¨æ€åº“ï¼Œå®Œå–„clang</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ“Œ Stage3</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ éªŒè¯æ­£ç¡®æ€§</span><p>
</div>

<!--v-->
## å·¥å…·é“¾

<div class="mul-cols">
<div class="col">

&nbsp;<span style="font-size: 0.8em;">ğŸ“Œ Stage1</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ¯ æœ€å°åŒ–çš„å·¥å…·é“¾</span><p>
<br><br><br>
&nbsp;<span style="font-size: 0.8em;">ğŸ“Œ Stage3</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ¯ éªŒè¯æ­£ç¡®æ€§</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ¯ if stage2==out(stage2(source))</span><p>

</div>
<div class="col">

<span style="font-size: 0.8em;">ğŸ“Œ Stage2</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ¯ å®Œå–„å·¥å…·é“¾</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ ä¾èµ–aospå†…éƒ¨åº“</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ libc.so</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ libaaudio.so</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ libGLESv2.so</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ ...</span><p>
</div>


<!--v-->
## å›¾å½¢æ ˆ
<div class="mul-cols">
<div class="col">

<div style="text-align: center;">
<img src="graphic_stack.png" width="100%" style="margin: 0 auto;">
</div>
</div>
<div class="col">
<li style="font-size: 24px;margin-bottom: 24px;">SurfaceFlingerï¼šç±»ä¼¼ X11/Wayland</li>
<li style="font-size: 24px;margin-bottom: 24px;">openGLESï¼šæ¸²æŸ“/è½¯ä»¶3Dåˆæˆ</li>
<li style="font-size: 24px;margin-bottom: 24px;">Hardware Composerï¼šç¡¬ä»¶æ¸²æŸ“åŠ é€Ÿ</li>
<li style="font-size: 24px;margin-bottom: 24px;">grallocï¼šç¼“å†²åŒºåˆ†é…</li>
<li style="font-size: 24px;margin-bottom: 24px;">mesaï¼šopenGLES çš„å¼€æºå®ç°</li>
<li style="font-size: 24px;margin-bottom: 24px;">libdrmï¼šandroidçš„è½¯ä»¶æŠ½è±¡å±‚</li>

</div>
<!--v-->
## å®‰å“è¿è¡Œæ—¶

<span style="font-size: 0.8em;">ğŸ’¡ è§£é‡Šå™¨ï¼šC++è§£é‡Šå™¨/nterpæ±‡ç¼–è§£é‡Šå™¨</span><p>
<div class="mul-cols">
<div class="col">

<div style="text-align: center;">
<img src="C++interpreter.png" width="100%" style="margin: 0 auto;">
</div>
</div>
<div class="col">

<div style="text-align: center;">
<img src="nterp_inter.png" width="100%" style="margin: 0 auto;">
</div>
</div>

<!--v-->
## å®‰å“è¿è¡Œæ—¶

<span style="font-size: 0.8em;">ğŸ’¡ è§£é‡Šå™¨ï¼šC++ vs nterp benchmark (CaffeineMark)</span><p>
<div style="text-align: center;">
<img src="c++_vs_nterp.png" width="75%" style="margin: 0 auto;">
</div>



<!--v-->
## å®‰å“è¿è¡Œæ—¶

<div class="mul-cols">
<div class="col">

<span style="font-size: 0.7em;">ğŸ’¡ mterpæ ˆå¸§(Android7.0-Android14)</span><p>
<div style="text-align: center;">
<img src="mterp_stack.png" width="90%" style="margin: 0 auto;">
</div>
</div>
<div class="col">

<span style="font-size: 0.7em;">ğŸ’¡ nterpæ ˆå¸§(Android15.0-)</span><p>
<div style="text-align: center;">
<img src="nterp_stack.png" width="95%" style="margin: 0 auto;">
</div>
</div>
<!--v-->
## å®‰å“è¿è¡Œæ—¶
<span style="font-size: 0.8em;">ğŸ’¡ JIT/AOTç¼–è¯‘å™¨</span><p>
```bash
Java Method -> HIR -> HGraph -> HBlock -> HIR -> Assembly
```
<div style="text-align: center;">
<br/>
<img src="codegen_framework.png" width="100%" style="margin: 0 auto;">
</div>


<!--s-->

<div class="middle center">
<div style="width: 100%">

# Part.3
<hr/>
AOSPç§»æ¤å®è·µ
</div>
</div>

<!--v-->
## ç§»æ¤å®è·µ
&nbsp;<span style="font-size: 0.8em;">âœ… 153ä¸ªä»“åº“</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">âœ… https://github.com/orgs/android-la64/repositories</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">âœ… http://8.140.33.210:2280</span><p>
&nbsp;<span style="font-size: 0.8em;">ğŸ“Œ ä¸€äº›æ”¹åŠ¨</span><p>
|repository | change |
|:--:|:--:|
|Bionic12| 273 files changed, 5530 insertions(+), 3067 deletions(-)|
|Bionic15| 293 files changed, 6052 insertions(+), 3036 deletions(-)|
|Android Runtime12| 98 files changed, 21275 insertions(+), 403 deletions(-)|
|Android Runtime15| 23 files changed, 6837 insertions(+), 252 deletions(-)|



<!--v-->
## ç§»æ¤å®è·µ

<div class="mul-cols">
<div class="col">

&nbsp;<span style="font-size: 0.8em;">âœ… Linuxå†…æ ¸</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… ç¼–è¯‘ç³»ç»Ÿ</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… å·¥å…·é“¾</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">âœ… clang</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">âœ… NDK</span><p>
&nbsp;&nbsp;<span style="font-size: 0.8em;">ğŸ› ï¸ Rust</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… Bionic</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… Graphic</span><p>
</div>
<div class="col">

<span style="font-size: 0.8em;">âœ… Android Runtime</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… C++ interpreter</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… nterp interpreter</span><p>
&nbsp;<span style="font-size: 0.8em;">âœ… JIT/AOT compiler</span><p>
<img src="aol-desk.png" width="100%" style="margin: 0 auto;">
</div>

<!--v-->
## ç§»æ¤å®è·µ
<div class="mul-cols">
<div class="col">

- å›¾å½¢é‡å®šå‘

<div style="text-align: center;">
<img src="graphic_stack_w.png" width="120%" style="margin: 0 auto;">
</div>
</div>
<div class="col">

- å®¹å™¨åŒ–å®‰å“
<br>
<br>
<br>
<img src="loongdroid.jpeg" width="100%" style="margin: 0 auto;">

</div>


<!--v-->
## ç§»æ¤å®è·µ
- PPTåœ°å€ï¼šhttps://baibaidashixiong.github.io/porting-android-la64
- é¡¹ç›®æ–‡æ¡£ï¼šhttps://github.com/android-la64/docs
- TODO:
  - CTSå…¼å®¹æµ‹è¯•å¥—ä»¶
  - ç»“æ„æ ‡å‡†åŒ–
  - ä¼˜åŒ–
  - ...

<div class=" center">
<div style="width: 100%">

<hr>
æ¬¢è¿åŠ å…¥ï¼

</div>
</div>

          </textarea>
        </section>
      </div>
    </div>   
    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        slideNumber: true,
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath.KaTeX
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {"transition":"slide","transitionSpeed":"fast","center":false,"slideNumber":"c/t","width":1000,"data-maxlines":10,"_":["main.md"],"scripts":"scripts/heti.js,scripts/heti_worker.js","template":"template.html","static":"../site","assets-dir":"assets","assetsDir":"assets"}, queryOptions);
    </script>

    <script src="./assets/scripts/heti.js"></script>
    <script src="./assets/scripts/heti_worker.js"></script>

    <script>
      Reveal.initialize(options).then(() => {
        document.querySelector(".backgrounds").setAttribute("style", document.querySelector(".slides").style.cssText);
      });
      Reveal.on('overviewshown', event => {
        document.querySelector(".backgrounds").setAttribute("style", "");
      });
      Reveal.on('overviewhidden', event => {
        document.querySelector(".backgrounds").setAttribute("style", document.querySelector(".slides").style.cssText);
      });
      Reveal.on('resize', event => {
        document.querySelector(".backgrounds").setAttribute("style", document.querySelector(".slides").style.cssText);
      });
    </script>
  </body>
</html>
